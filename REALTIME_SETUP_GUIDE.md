# Supabase リアルタイム連動設定ガイド

## 🎯 概要
利用者側で追加したデータが施設側にリアルタイムで反映されるように、Supabaseのリアルタイム機能を有効にする必要があります。

## 📋 設定手順

### 1. Supabaseダッシュボードにアクセス
1. https://supabase.com/ にアクセス
2. プロジェクトを選択

### 2. Replicationsの設定
1. 左サイドバーから「**Database**」→「**Replication**」をクリック
2. 以下のテーブルを見つけて、リアルタイムを有効にします：

#### 有効にするテーブル：
- ✅ `records` - 保護者が追加する日々の記録
- ✅ `growth_records` - 保護者が追加する成長記録（写真付き）

### 3. 各テーブルのリアルタイムを有効化

#### `records` テーブル
1. `records` テーブルの行を見つける
2. 「**Source**」列のトグルを**ON**にする
3. 「**Insert**」イベントが有効になっていることを確認

#### `growth_records` テーブル
1. `growth_records` テーブルの行を見つける
2. 「**Source**」列のトグルを**ON**にする
3. 「**Insert**」イベントが有効になっていることを確認

### 4. 設定の確認
設定が完了したら、ブラウザのコンソールで以下のログが表示されることを確認してください：

```
✅ recordsテーブルのリアルタイム連動が正常に開始されました
✅ growth_recordsテーブルのリアルタイム連動が正常に開始されました
```

## 🧪 動作テスト

### テスト手順：
1. **保護者アプリ**を開く
2. 記録を追加する（「できた」「嬉しい」など）
3. **施設側アプリ**を開く（別のブラウザタブ）
4. **自動的に**新しい記録が表示されることを確認

### 期待される動作：
- ✨ 保護者が記録を追加すると、数秒以内に施設側に表示される
- 📡 コンソールに「✨✨✨ 新しい記録が追加されました（リアルタイム）」と表示される
- 🔄 30秒ごとに自動的にデータが更新される（バックアップ）

## 🚨 トラブルシューティング

### リアルタイムが動作しない場合：

#### 1. コンソールエラーを確認
ブラウザのコンソールで以下のエラーがないか確認：
```
❌ recordsテーブルのリアルタイム連動でエラーが発生しました
❌ growth_recordsテーブルのリアルタイム連動でエラーが発生しました
```

#### 2. Replicationの設定を再確認
- SupabaseダッシュボードでReplicationが正しく有効になっているか確認
- ページをリロードして設定が保存されているか確認

#### 3. ネットワーク接続を確認
- WebSocket接続が許可されているか確認
- ファイアウォールやプロキシがWebSocketをブロックしていないか確認

#### 4. 定期更新の確認
リアルタイムが動作しない場合でも、30秒ごとに自動的にデータが更新されます。
コンソールで以下のログを確認：
```
🔄 定期更新: 成長記録を再取得
```

## 📝 追加情報

### バックアップ機能
リアルタイム連動が一時的に失敗しても、以下のバックアップ機能があります：
- 30秒ごとの定期更新
- ページリロード時の自動再取得
- 手動更新ボタン（実装済み）

### セキュリティ
リアルタイム機能は、Row Level Security (RLS) ポリシーを尊重します。
各施設は自分の施設のデータのみにアクセスできます。

## 🎉 完了！
設定が完了したら、利用者側で追加したデータが施設側にリアルタイムで反映されるようになります！

